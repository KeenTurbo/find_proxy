#!/bin/bash

# --- ä¿®æ­£1: ç¡®ä¿æˆ‘ä»¬åœ¨æ­£ç¡®çš„é¡¹ç›®ç›®å½•ä¸‹ ---
# è„šæœ¬å°†ä»Žå½“å‰ç›®å½•æ‰§è¡Œï¼Œè¯·ç¡®ä¿æ‚¨å·²åœ¨ /root/grok2api ç›®å½•ä¸‹
echo "âœ… å½“å‰ç›®å½•: $(pwd)"

# --- ä»£ç†åˆ—è¡¨ ---
# ä»Žæ–‡æ¡£æå–çš„ä»£ç†åˆ—è¡¨ï¼ˆæ³¨æ„ï¼šè¿™äº›æ˜¯å…è´¹å…¬å…±ä»£ç†ï¼ŒæˆåŠŸçŽ‡å¾ˆä½Žï¼‰
cat > /tmp/elite_proxies.txt << 'EOL'
47.252.81.108:8118
47.252.29.28:11222
198.54.124.88:8080
192.64.112.150:8080
162.240.19.30:80
108.170.12.10:80
129.213.69.94:80
5.161.103.41:88
192.73.244.36:80
82.180.132.69:80
147.75.34.92:9443
41.32.39.7:3128
8.210.17.35:8445
147.75.34.105:443
35.183.64.191:30309
43.156.15.111:20002
113.163.5.253:8080
5.252.33.13:2025
195.114.209.50:80
45.22.209.157:8888
154.65.39.8:80
202.181.16.173:3325
38.54.71.67:80
156.38.112.11:80
46.39.105.157:8080
182.52.165.147:8080
14.251.13.0:8080
EOL

echo "ðŸš€ ä»£ç†æ± å¯åŠ¨ï¼šå¼€å§‹æµ‹è¯•ä»£ç†..."

BEST_PROXY=""
FASTEST_TIME=10 # è®¾ç½®ä¸€ä¸ªè¾ƒé«˜çš„åˆå§‹å“åº”æ—¶é—´

# --- ä»£ç†æµ‹è¯•å¾ªçŽ¯ ---
for proxy in $(cat /tmp/elite_proxies.txt | sort -u); do # ä½¿ç”¨ sort -u åŽ»é‡
  echo "ðŸ§ª æµ‹è¯•: http://$proxy"
  # ä½¿ç”¨ curl æµ‹è¯•ä»£ç†æ˜¯å¦èƒ½è®¿é—® httpbin.orgï¼Œè¶…æ—¶æ—¶é—´ä¸º5ç§’
  # -s é™é»˜æ¨¡å¼, -I åªèŽ·å–å¤´éƒ¨ä¿¡æ¯, -m è¶…æ—¶æ—¶é—´, -x ä½¿ç”¨ä»£ç†
  RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" -x "http://$proxy" https://httpbin.org/get -m 5)
  
  # æ£€æŸ¥ curl æ˜¯å¦æˆåŠŸæ‰§è¡Œ (é€€å‡ºç ä¸º0) å¹¶ä¸”å“åº”æ—¶é—´å°äºŽè®°å½•çš„æœ€å¿«æ—¶é—´
  if [ $? -eq 0 ] && (( $(echo "$RESPONSE_TIME < $FASTEST_TIME" | bc -l) )); then
    BEST_PROXY="$proxy"
    FASTEST_TIME=$RESPONSE_TIME
    echo "âœ… æ‰¾åˆ°æ›´ä¼˜ä»£ç†: http://$proxy (å“åº”æ—¶é—´: ${FASTEST_TIME}ç§’)"
  fi
done

# --- æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°å¯ç”¨ä»£ç†å¹¶æ›´æ–°é…ç½® ---
if [ -n "$BEST_PROXY" ]; then
  echo "ðŸ† é€‰å®šæœ€ä¼˜ä»£ç†: http://$BEST_PROXY (å“åº”æ—¶é—´: ${FASTEST_TIME}ç§’)"
  
  # --- ä¿®æ­£2: ä½¿ç”¨ docker exec åœ¨å®¹å™¨å†…éƒ¨ä¿®æ”¹é…ç½®æ–‡ä»¶ ---
  # åŠ¨æ€èŽ·å–å®¹å™¨å
  CONTAINER_NAME=$(docker compose ps -q)
  if [ -z "$CONTAINER_NAME" ]; then
    echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ­£åœ¨è¿è¡Œçš„grok2apiå®¹å™¨ï¼"
    exit 1
  fi
  
  echo "âœï¸ æ­£åœ¨æ›´æ–°å®¹å™¨ $CONTAINER_NAME å†…çš„é…ç½®æ–‡ä»¶..."
  # ä½¿ç”¨ # ä½œä¸º sed çš„åˆ†éš”ç¬¦ï¼Œé¿å…ä¸ŽURLä¸­çš„ / å†²çª
  docker compose exec "$CONTAINER_NAME" sed -i "s#proxy_url = \".*\"#proxy_url = \"http://$BEST_PROXY\"#" /app/data/setting.toml
  
  echo "ðŸ”„ é‡å¯grok2apiæœåŠ¡ä»¥åº”ç”¨æ–°é…ç½®..."
  docker compose restart
  sleep 5 # ç­‰å¾…æœåŠ¡é‡å¯
  
  echo "ðŸ”¬ æœ€ç»ˆæµ‹è¯•ï¼šå‘æœ¬åœ°grok2apiæœåŠ¡å‘é€ä¸€ä¸ªè¯·æ±‚..."
  # --- ä¿®æ­£3: åœ¨æœ€ç»ˆæµ‹è¯•ä¸­åŠ å…¥è®¤è¯å¤´ ---
  # è¯·å°† YOUR_API_KEY_HERE æ›¿æ¢ä¸ºæ‚¨åœ¨åŽå°è®¾ç½®çš„çœŸå®žAPI Key
  API_KEY="YOUR_API_KEY_HERE" 
  curl -s -X POST http://localhost:8000/v1/chat/completions \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $API_KEY" \
    -d '{"model": "grok-4-fast", "messages": [{"role": "user", "content": "ä½ å¥½ï¼Œæµ‹è¯•ä»£ç†æ˜¯å¦æˆåŠŸ"}], "stream": false}'
  echo "" # æ¢è¡Œ
  echo "ðŸŽ‰ è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼è¯·æ£€æŸ¥ä¸Šé¢çš„è¾“å‡ºåˆ¤æ–­æ˜¯å¦æˆåŠŸã€‚"

else
  echo "âŒ é—æ†¾ï¼šåœ¨æ­¤æ¬¡æµ‹è¯•ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯ç”¨çš„ä»£ç†ã€‚"
fi

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f /tmp/elite_proxies.txt